# Теоретическая часть контрольной работы
## Вариант 4

**Дисциплина:** Разработка на Python. Профессиональный

**Фамилия, Имя:** _________________________________

---

### Вопрос 1
Когда использовать `BackgroundTasks`, а когда APScheduler? Отметь все подходящие варианты.

- [ ] APScheduler — для задач, не зависящих от ответа
- [ ] `BackgroundTasks` для действий после конкретного запроса, APScheduler — для периодических задач
- [ ] APScheduler требует явного вызова `scheduler.start()`
- [ ] `BackgroundTasks` запускаются сразу, APScheduler — по триггеру

### Вопрос 2
Redis используется для кеша конфигурации. Как обезопасить соединение в проде? Отметь все подходящие варианты.

- [ ] Оставить Redis без авторизации
- [ ] Включить TLS и проверить сертификат
- [ ] Использовать пароль или ACL
- [ ] Использовать встроенный firewall

### Вопрос 3
Нужно добавить логирование тела ответов для POST-запросов. Как избежать потери данных в ответе?

- [ ] Использовать `response.body_iterator` напрямую без копирования
- [ ] Использовать `response.body` без создания нового `Response`
- [ ] Скопировать тело, а затем создать новый `Response` с исходными данными
- [ ] Логировать только заголовки ответа

### Вопрос 4
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения? Отметь все подходящие варианты.

- [ ] Передавать подключения через аргументы эндпоинта
- [ ] Создать зависимость `get_cache` для Redis
- [ ] Создать зависимость `get_db` и использовать Depends, возвращая сессию
- [ ] Создавать соединение внутри эндпоинта через глобальную переменную

### Вопрос 5
Как масштабировать настройку приложения через DI?

- [ ] Определить pydantic-модель `Settings` и инжектить её через зависимость
- [ ] Читать `.env` внутри каждого эндпоинта
- [ ] Передавать конфигурацию через тело запроса
- [ ] Хранить настройки в глобальной переменной модуля

### Вопрос 6
Middleware добавляет `user` в `request.state`. Как защититься от отсутствия пользователя?

- [ ] Читать пользователя из `request.headers.get("X-User")`
- [ ] В эндпоинтах проверять `hasattr(request.state, "user")` и бросать 401 при отсутствии
- [ ] Использовать dependency injection с проверкой наличия пользователя
- [ ] Использовать `request.app.state.user` для хранения пользователя

### Вопрос 7
Кеш API иногда даёт устаревшие данные. Какие причины наиболее вероятны? Отметь все подходящие варианты.

- [ ] Источник обновил данные без сброса кеша
- [ ] Несогласованность между инстансами, использующими разные ключи
- [ ] TTL слишком большой
- [ ] Кеш не был инвалидирован после обновления данных

### Вопрос 8
Как сохранить состояние планировщика при рестарте приложения? Отметь все подходящие варианты.

- [ ] Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Запускать APScheduler в отдельном процессе
- [ ] Использовать persistent job store (Redis, Б
- [ ] Г) Настроить `lifespan` для управления жизненным циклом

### Вопрос 9
Middleware собирает метрики времени. Какие значения нужно логировать? Отметь все подходящие варианты.

- [ ] Время ответа
- [ ] Количество запросов в секунду
- [ ] `latency`
- [ ] Время начала

### Вопрос 10
Эндпоинт возвращает отчёт, который пересчитывается раз в сутки. Как сохранить производительность и актуальность? Отметь все подходящие варианты.

- [ ] Использовать ленивое обновление (stale-while-revalidate)
- [ ] Использовать только TTL без событийной инвалидации
- [ ] Кешировать отчёт с суточным TTL и инвалидировать при обновлении
- [ ] Кешировать отчёт с очень коротким TTL (несколько минут)

### Вопрос 11
Почему DI помогает поддерживать крупные проекты? Отметь все подходящие варианты.

- [ ] Упрощает рефакторинг зависимостей без изменения всех эндпоинтов
- [ ] Позволяет тестировать код с заглушками
- [ ] Централизует управление ресурсами
- [ ] Упрощает замену реализаций сервисов

### Вопрос 12
Логирование перегружается из-за лишних полей. Что нужно оставить для технических логов? Отметь все подходящие варианты.

- [ ] `request_id`
- [ ] `status_code`
- [ ] `message`
- [ ] `path`

### Вопрос 13
Создаётся общая обёртка вокруг кеша в FastAPI. Какие элементы нужно включить? Отметь все подходящие варианты.

- [ ] Функцию генерации ключей
- [ ] Инвалидацию при записи в БД
- [ ] Обработку ошибок при работе с Redis
- [ ] Сериализацию ответов

### Вопрос 14
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

- [ ] Использовать общий форматтер для всех логгеров через `basicConfig`
- [ ] Настроить общий форматтер и подключить его ко всем логгерам
- [ ] Создать middleware, которое добавляет формат каждому сообщению
- [ ] Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст

### Вопрос 15
В новом проекте внедряется middleware, который должен проставлять `request_id` и `correlation_id`. Как сохранить оба значения для дальнейших обработчиков?

- [ ] Записать их в `request.state`, а затем добавить заголовки после `call_next`
- [ ] Передавать через заголовки запроса
- [ ] Сохранить в `request.app.state` для всех запросов
- [ ] Использовать только `request_id`, игнорируя `correlation_id`

### Вопрос 16
Ключ кеша должен учитывать параметры фильтра `region` и `department`. Как оформить ключ, чтобы команда могла его поддерживать?

**Ответ:**

_________________________________


### Вопрос 17
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

- [ ] Настроить `lifespan` для управления жизненным циклом
- [ ] Добавить задачу с `IntervalTrigger(minutes=15)`
- [ ] Запустить `scheduler.start()`
- [ ] Создать `AsyncIOScheduler`

### Вопрос 18
Нужно сбросить кеш конкретного клиента при изменении его данных. Какие шаги подходят? Отметь все подходящие варианты.

- [ ] Ждать истечения TTL
- [ ] Использовать префикс `client:<id>` и удалять через `SCAN`
- [ ] Хранить ключи клиента в `SET` и удалять их
- [ ] Использовать `KEYS client:<id>:*` и удалять найденные ключи

### Вопрос 19
Как узнать, сколько осталось до истечения ключа `dashboard:data`? Отметь все подходящие варианты.

- [ ] `TTL dashboard:data`
- [ ] `GET dashboard:data`
- [ ] `EXPIRE dashboard:data 60`
- [ ] `PTTL dashboard:data`

### Вопрос 20
Метод `/metrics` обновляется каждые 15 минут. Какой TTL поставить для кеша ответа, чтобы балансировать свежесть и нагрузку?

- [ ] 15 минут
- [ ] 1 час
- [ ] 5 минут
- [ ] Без кеша

### Вопрос 21
Нужно, чтобы middleware добавляло `X-Service-Version` в каждый ответ. Какие шаги нужны? Отметь все подходящие варианты.

- [ ] Вызвать `response = await call_next(request)`
- [ ] В middleware получить версию сервиса
- [ ] Добавить заголовок `response.headers["X-Service-Version"]`
- [ ] Добавить заголовок в `request.headers` до вызова `call_next`

### Вопрос 22
Создаётся middleware для логирования запросов. В чём разница между функциональным подходом (`@app.middleware("http")`) и классовым (`BaseHTTPMiddleware`)?

- [ ] Функциональный подход проще для простых случаев, классовый — для сложной логики
- [ ] Функциональный подход не позволяет передавать параметры конфигурации, классовый позволяет через конструктор
- [ ] Классовый подход требует наследования от `BaseHTTPMiddleware`
- [ ] Функциональный подход требует явного указания типа middleware

### Вопрос 23
Нужно удалить кеш при обновлении товара. Какую команду Redis использовать?

**Ответ:**

_________________________________


### Вопрос 24
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься? Отметь все подходящие варианты.

- [ ] Логировать ошибки
- [ ] Оборачивать задачу в try/except
- [ ] Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Добавить уведомления при исключениях

### Вопрос 25
В логах нужно быстро находить записи по пользователю. Какие поля включить? Отметь все подходящие варианты. Отметь все подходящие варианты.

- [ ] `user_id`
- [ ] `message`
- [ ] `timestamp`
- [ ] `level`

### Вопрос 26
Нужно ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

- [ ] Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии
- [ ] Хранить ключ в глобальной переменной без проверки
- [ ] Использовать middleware без проверки ключа
- [ ] Проверять ключ внутри каждого эндпоинта

### Вопрос 27
На каком уровне логировать успешное завершение фоновой задачи?

- [ ] WARNING
- [ ] INFO
- [ ] DEBUG
- [ ] ERROR

