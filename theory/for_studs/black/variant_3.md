# Теоретическая часть контрольной работы
## Вариант 3

**Дисциплина:** Разработка на Python. Профессиональный

**Фамилия, Имя:** _________________________________

---

### Вопрос 1
В апи-gateway нужно добавить middleware, который проставляет `trace_id` для всех запросов. Как обеспечить, чтобы downstream-сервисы тоже получали идентификатор?

- [ ] Передавать `trace_id` через `request.state` без заголовков
- [ ] Записывать `trace_id` в `request.state`, а затем добавлять его в заголовок ответа
- [ ] Добавлять `trace_id` только в заголовки ответа, без сохранения в `request.state`
- [ ] Проставлять заголовок `X-Trace-Id` до вызова `call_next`

### Вопрос 2
Нужно собирать метрики по времени обработки запроса. Какие значения нужно логировать? Отметь все подходящие варианты.

- [ ] Время начала запроса
- [ ] `request.url.path`
- [ ] Время окончания
- [ ] Разницу во времени (latency)

### Вопрос 3
Создаётся слой кеширования поверх сервисов. Что нужно предусмотреть на этапе дизайна? Отметь все подходящие варианты.

- [ ] Сериализацию и десериализацию данных
- [ ] Логику формирования ключа
- [ ] Механизм cache busting при обновлении
- [ ] Обработку ошибок подключения к Redis

### Вопрос 4
Как узнать остаток времени жизни ключа `inventory:summary`? Отметь все подходящие варианты.

- [ ] `GET inventory:summary`
- [ ] `TTL inventory:summary`
- [ ] `EXPIRE inventory:summary 60`
- [ ] `PTTL inventory:summary`

### Вопрос 5
Внедряется middleware для добавления `request_id`. Какие шаги обязательны? Отметь все подходящие варианты.

- [ ] Использовать только входящий `X-Request-Id`, не генерировать новый
- [ ] Записать `request_id` в `request.state` и заголовки ответа
- [ ] Проверить, есть ли `X-Request-Id` в входящих заголовках
- [ ] Сгенерировать новый `uuid4`, если идентификатора нет

### Вопрос 6
Middleware навешивает `user` в `request.state`. Как организовать доступ к нему из зависимостей?

- [ ] Использовать `Depends` с функцией, которая читает из `request.state`
- [ ] Использовать `request.app.state.user` для хранения пользователя
- [ ] Передавать пользователя через заголовки запроса
- [ ] В зависимости получить `request: Request` и читать `request.state.user`

### Вопрос 7
Почему DI полезен при поддержке сервисов с множеством интеграций? Отметь все подходящие варианты.

- [ ] Централизует управление жизненным циклом ресурсов
- [ ] Упрощает рефакторинг зависимостей без изменения всех эндпоинтов
- [ ] Упрощает тестирование с помощью заглушек
- [ ] Позволяет подменять реализации (staging vs prod)

### Вопрос 8
Нужно удалить кеш при обновлении товара. Какую команду Redis использовать?

**Ответ:**

_________________________________


### Вопрос 9
На каком уровне логировать неожиданные исключения обработчика?

- [ ] WARNING
- [ ] DEBUG
- [ ] ERROR
- [ ] INFO

### Вопрос 10
Как масштабировать конфиги приложения через DI?

- [ ] Читать `.env` в каждом эндпоинте
- [ ] Передавать конфигурацию через заголовки
- [ ] Создать `Settings` на базе `pydantic` и внедрять через зависимость
- [ ] Хранить настройки в глобальной переменной модуля

### Вопрос 11
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения? Отметь все подходящие варианты.

- [ ] Создать зависимость `get_cache` для Redis
- [ ] Создавать соединение внутри эндпоинта через глобальную переменную
- [ ] Передавать подключения через аргументы эндпоинта
- [ ] Создать зависимость `get_db` и использовать Depends, возвращая сессию

### Вопрос 12
Логирование производительности API зашумлено. Какие данные нужно оставить? Отметь все подходящие варианты.

- [ ] `duration_ms`
- [ ] `method`
- [ ] `endpoint`
- [ ] `request_id`

### Вопрос 13
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься? Отметь все подходящие варианты.

- [ ] Логировать ошибки
- [ ] Добавить уведомления при исключениях
- [ ] Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Оборачивать задачу в try/except

### Вопрос 14
В проекте используются три middleware: `AuthMiddleware`, `TimingMiddleware` и `LoggingMiddleware`. Они подключены в таком порядке:
```python
app.add_middleware(AuthMiddleware)
app.add_middleware(TimingMiddleware)
app.add_middleware(LoggingMiddleware)
```
В каком порядке они выполняются при обработке запроса?

- [ ] LoggingMiddleware → TimingMiddleware → AuthMiddleware → обработчик → AuthMiddleware → TimingMiddleware → LoggingMiddleware
- [ ] Порядок определяется порядком регистрации, но только для request-части
- [ ] Все middleware выполняются параллельно до обработчика
- [ ] AuthMiddleware → TimingMiddleware → LoggingMiddleware → обработчик → LoggingMiddleware → TimingMiddleware → AuthMiddleware

### Вопрос 15
Redis используется как кеш конфигурации. Какие настройки важны на клиенте? Отметь все подходящие варианты.

- [ ] Таймаут выполнения команд
- [ ] Максимальное число повторных попыток
- [ ] Таймаут подключения
- [ ] Пароль для аутентификации

### Вопрос 16
Сервис возвращает отчёты, обновляемые раз в час. Как минимизировать задержки и поддерживать свежесть? Отметь все подходящие варианты.

- [ ] Устанавливать TTL = 3600 секунд
- [ ] Инвалидировать кеш по событию обновления данных
- [ ] Кешировать отчёт, но запускать фоновые задачи, которые обновляют кеш заранее
- [ ] Использовать только TTL без событийной инвалидации

### Вопрос 17
Middleware логирует ответы, включая тела JSON. Какие риски нужно учитывать? Отметь все подходящие варианты.

- [ ] В логах могут оказаться чувствительные данные
- [ ] Повторное чтение тела может потребовать восстановить `response.body`
- [ ] Тело ответа можно читать только один раз без восстановления потока
- [ ] Логирование больших тел увеличивает задержку

### Вопрос 18
Кеш должен учитывать локаль (`lang`) и валюту (`currency`). Как сформировать ключ, чтобы поддержка понимала логику?

**Ответ:**

_________________________________


### Вопрос 19
Нужно обновить только часть кеша при изменении сегмента пользователей. Какие подходы подходят? Отметь все подходящие варианты.

- [ ] Использовать `KEYS segment:<id>:*` и удалять найденные ключи
- [ ] Не обновлять кеш, ждать истечения TTL
- [ ] Использовать префикс `segment:<id>:*` и удалять по SCAN
- [ ] Использовать набор ключей и очищать сегмент по списку

### Вопрос 20
Какие причины могут привести к устаревшему кешу? Отметь все подходящие варианты.

- [ ] Разные инстансы системы используют разные ключи
- [ ] Истёк TTL
- [ ] Источник данных обновился без инвалидации
- [ ] Кеш был установлен с очень длинным TTL без обновления

### Вопрос 21
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

- [ ] Создать middleware, которое добавляет формат каждому сообщению
- [ ] Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст
- [ ] Настроить общий форматтер и подключить его ко всем логгерам
- [ ] Использовать общий форматтер для всех логгеров через `basicConfig`

### Вопрос 22
Нужно определить, когда использовать `BackgroundTasks`, а когда APScheduler. Какие критерии верны? Отметь все подходящие варианты.

- [ ] APScheduler подходит для периодических задач
- [ ] `BackgroundTasks` запускаются после формирования ответа
- [ ] `BackgroundTasks` привязан к запросу, APScheduler — к расписанию
- [ ] APScheduler требует явного вызова `scheduler.start()`

### Вопрос 23
Нужно кешировать ответ `/weather`, который обновляется каждые 5 минут. Какой TTL выбрать?

- [ ] 30 секунд
- [ ] Без TTL
- [ ] 1 час
- [ ] 5 минут

### Вопрос 24
Чтобы логи были пригодны для поиска, какие поля нужно включить в формат? Отметь все подходящие варианты.

- [ ] `service_name`
- [ ] `level`
- [ ] `message`
- [ ] `timestamp`

### Вопрос 25
Как гарантировать, что планировщик продолжит работу после рестарта приложения? Отметь все подходящие варианты.

- [ ] Хранить задания в persistent store вроде Redis
- [ ] Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Запускать APScheduler отдельно от основного приложения
- [ ] Настроить `lifespan` для управления жизненным циклом

### Вопрос 26
Нужно ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

- [ ] Использовать middleware без проверки ключа
- [ ] Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии
- [ ] Хранить ключ в глобальной переменной без проверки
- [ ] Проверять ключ внутри каждого эндпоинта

### Вопрос 27
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

- [ ] Добавить задачу с `IntervalTrigger(minutes=15)`
- [ ] Настроить `lifespan` для управления жизненным циклом
- [ ] Создать `AsyncIOScheduler`
- [ ] Запустить `scheduler.start()`

