# Теоретическая часть контрольной работы
## Вариант 6

**Дисциплина:** Разработка на Python. Профессиональный

**Фамилия, Имя:** _________________________________

---

### Вопрос 1
Эндпоинт `/prices` обновляется каждые 2 минуты. Какой TTL поставить для кеша ответа?

- [ ] 30 минут
- [ ] 120 секунд
- [ ] 5 секунд
- [ ] Без TTL

### Вопрос 2
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься?

- [ ] Оборачивать задачу в try/except
- [ ] Логировать ошибки
- [ ] Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Добавить уведомления при исключениях

### Вопрос 3
Как внедрять настройки приложения через DI?

- [ ] Передавать настройки через заголовки
- [ ] Создать `Settings` на базе `pydantic` и инжектировать через зависимость
- [ ] Хранить настройки в глобальной переменной модуля
- [ ] Читать `.env` в каждом эндпоинте

### Вопрос 4
Нужно централизованно проставлять `X-Env` в ответах. Какие шаги нужны в middleware? Отметь все подходящие варианты.

- [ ] Добавить заголовок в `response.headers`
- [ ] Вызвать `response = await call_next(request)`
- [ ] Получить значение окружения из настроек
- [ ] Добавить заголовок в `request.headers` до вызова `call_next`

### Вопрос 5
Как быстро посмотреть, сколько осталось жить ключу `promo:active`?

- [ ] `PTTL promo:active`
- [ ] `GET promo:active`
- [ ] `EXPIRE promo:active 60`
- [ ] `TTL promo:active`

### Вопрос 6
В сервисе добавляется middleware для проставления `trace_id`. Где генерировать идентификатор, чтобы он попал во все downstream-вызовы?

- [ ] После получения ответа
- [ ] В отдельном middleware, который выполняется последним
- [ ] В dependency injection через `Depends`
- [ ] До `await call_next(request)`, сохранив значение в `request.state` и заголовках

### Вопрос 7
Отчёты формируются долго, но обновляются каждые 4 часа. Как держать данные актуальными и снизить нагрузку? Отметь все подходящие варианты.

- [ ] Использовать только TTL без событийной инвалидации
- [ ] Настроить фоновые задачи, обновляющие кеш заранее
- [ ] Кешировать результаты и инвалидировать по событию
- [ ] Кешировать отчёт с очень коротким TTL (несколько минут)

### Вопрос 8
Логируется тело ответа в middleware. Какие риски стоит учитывать? Отметь все подходящие варианты.

- [ ] Потребуется восстановить поток, иначе клиент получит пустой ответ
- [ ] В логи могут попасть ПДн
- [ ] Тело ответа можно читать только один раз без восстановления потока
- [ ] Увеличатся задержки из-за сериализации

### Вопрос 9
Как сбросить кеш сегмента клиентов при обновлении данных?

- [ ] Использовать `KEYS segment:<id>:*` и удалять найденные ключи
- [ ] Хранить ключи сегмента в `SET` и удалять их
- [ ] Удалять по `segment:<id>:*` через `SCAN`
- [ ] Ждать истечения TTL

### Вопрос 10
Redis используется как кеш для справочников. Какие параметры клиента критичны? Отметь все подходящие варианты.

- [ ] Количество попыток переподключения
- [ ] Таймаут подключения
- [ ] Таймаут команд
- [ ] Пароль для аутентификации

### Вопрос 11
Middleware добавляет `user_id` в `request.state`. Как безопасно использовать его в зависимости?

- [ ] Читать `user_id` из `request.headers.get("X-User-Id")`
- [ ] Использовать `request.app.state.user_id` для хранения
- [ ] Проверить наличие атрибута и вернуть 401 при отсутствии
- [ ] Использовать dependency injection без проверки наличия значения

### Вопрос 12
Создаётся кеширующий слой. Какие компоненты обязательны? Отметь все подходящие варианты.

- [ ] Функция формирования ключей
- [ ] Сериализация/десериализация данных
- [ ] Инвалидация при событии обновления
- [ ] Обработка ошибок при работе с Redis

### Вопрос 13
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения?

- [ ] Создать зависимость `get_db` и использовать Depends, возвращая сессию
- [ ] Создавать соединение внутри эндпоинта через глобальную переменную
- [ ] Создать зависимость `get_cache` для Redis
- [ ] Передавать подключения через аргументы эндпоинта

### Вопрос 14
Ключ кеша должен учитывать `product_id` и `currency`. Как построить ключ, чтобы поддержка понимала структуру?

**Ответ:**

_________________________________


### Вопрос 15
Почему DI облегчает поддержку и развитие сервисов? Отметь все подходящие варианты.

- [ ] Централизует контроль жизненного цикла ресурсов
- [ ] Позволяет подменять реализации (mock vs prod)
- [ ] Упрощает тестирование за счёт заглушек
- [ ] Упрощает рефакторинг зависимостей без изменения всех эндпоинтов

### Вопрос 16
Чтобы логи были пригодны для анализа инцидентов, какие поля нужно добавить? Отметь все подходящие варианты.

- [ ] `message`
- [ ] `timestamp`
- [ ] `level`
- [ ] `service`

### Вопрос 17
Нужно объявить асинхронную зависимость, которая подключается к Redis и закрывает соединение после использования. Какой шаблон подойдёт?
```python
async def get_redis():
    async with aioredis.from_url(URL) as conn:
        yield conn
```
(принимаются эквиваленты с `yield`)

**Ответ:**

_________________________________


### Вопрос 18
Чем `BackgroundTasks` отличается от APScheduler? Отметь все подходящие варианты.

- [ ] APScheduler требует явного вызова `scheduler.start()`
- [ ] APScheduler работает по расписанию
- [ ] `BackgroundTasks` привязан к конкретному запросу
- [ ] `BackgroundTasks` запускает действия сразу после ответа

### Вопрос 19
Какой уровень логирования выбрать для неожиданной ошибки бизнес-логики?

- [ ] WARNING
- [ ] INFO
- [ ] ERROR
- [ ] DEBUG

### Вопрос 20
Измеряется время ответа в middleware. Что записывать в лог? Отметь все подходящие варианты.

- [ ] Размер ответа в байтах
- [ ] Продолжительность запроса
- [ ] Timestamp окончания
- [ ] Timestamp начала

### Вопрос 21
Подключается middleware через `app.add_middleware(LoggingMiddleware)`. Какой базовый класс должен наследовать `LoggingMiddleware` для такого способа подключения?

- [ ] Любой класс с методом `async def dispatch`
- [ ] `Middleware` из `fastapi.middleware`
- [ ] `ASGIMiddleware` из `starlette.middleware`
- [ ] `BaseHTTPMiddleware` из `starlette.middleware.base`

### Вопрос 22
Логирование заполняет диски, нужно оставить только полезные поля. Что нужно логировать? Отметь все подходящие варианты.

- [ ] `request_id`
- [ ] `status_code`
- [ ] `message`
- [ ] `method`

### Вопрос 23
Нужно ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

- [ ] Использовать middleware без проверки ключа
- [ ] Хранить ключ в глобальной переменной без проверки
- [ ] Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии
- [ ] Проверять ключ внутри каждого эндпоинта

### Вопрос 24
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

- [ ] Настроить `lifespan` для управления жизненным циклом
- [ ] Добавить задачу с `IntervalTrigger(minutes=15)`
- [ ] Запустить `scheduler.start()`
- [ ] Создать `AsyncIOScheduler`

### Вопрос 25
Как обеспечить сохранность расписания при рестарте приложения?

- [ ] Настроить `lifespan` для управления жизненным циклом
- [ ] Использовать persistent job store (Redis, Б
- [ ] В) Использовать `scheduler.shutdown()` при завершении приложения
- [ ] Запускать APScheduler в отдельном процессе

### Вопрос 26
Кеш возвращает устаревшие данные по заказам. Какие причины стоит проверить? Отметь все подходящие варианты.

- [ ] Кеш не был инвалидирован после обновления данных
- [ ] TTL слишком длинный
- [ ] Нет инвалидации после обновления заказов
- [ ] Разные сервисы используют разные префиксы ключей

### Вопрос 27
Как удалить кеш при обновлении товара? Какую команду Redis использовать?

**Ответ:**

_________________________________


### Вопрос 28
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

- [ ] Создать middleware, которое добавляет формат каждому сообщению
- [ ] Использовать общий форматтер для всех логгеров через `basicConfig`
- [ ] Настроить общий форматтер и подключить его ко всем логгерам
- [ ] Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст

