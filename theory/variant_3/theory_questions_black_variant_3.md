# Теоретическая часть контрольной работы. Вариант 3
## Разработка на Python. Профессиональный

### Вопрос 1
В апи-gateway нужно добавить middleware, который проставляет `trace_id` для всех запросов. Как убедиться, что downstream-сервисы тоже получают идентификатор?

А) Записывать `trace_id` в `request.state`, а затем добавлять его в заголовок ответа  
Б) Проставлять заголовок `X-Trace-Id` до вызова `call_next`  
В) Передавать `trace_id` через query-параметр  
Г) Сохранять `trace_id` в базе данных

**Правильный ответ:** Б

**Проверяемый ОР:** Знает. - Что такое middleware и его роль в обработке запросов и ответов.

### Вопрос 2
Ты внедряешь middleware для добавления `request_id`. Какие шаги обязательны? Отметь все подходящие варианты.

А) Проверить, есть ли `X-Request-Id` в входящих заголовках  
Б) Сгенерировать новый `uuid4`, если идентификатора нет  
В) Записать `request_id` в `request.state` и заголовки ответа  
Г) Прервать запрос, если заголовок отсутствует

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 3
Middleware должен отказать в доступе, если запрос пришёл из чёрного списка IP. Как правильно отреагировать?

А) Вернуть `JSONResponse` с 403 и не вызывать `call_next`  
Б) Вызвать `call_next`, затем 403  
В) Логировать, но пропускать дальше  
Г) Вызывать глобальную переменную `BLACKLIST`

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему middleware полезен для централизованной обработки запросов.

### Вопрос 4
Middleware логирует ответы, включая тела JSON. Какие риски стоит учитывать? Отметь все подходящие варианты.

А) Повторное чтение тела может потребовать восстановить `response.body`  
Б) Логирование больших тел увеличивает задержку  
В) В логах могут оказаться чувствительные данные  
Г) JSON автоматически шифруется в логах

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware влияет на производительность приложения.

### Вопрос 5
Middleware навешивает `user` в `request.state`. Как организовать доступ к нему из зависимостей?

А) В зависимости получить `request: Request` и читать `request.state.user`  
Б) Копировать пользователя в глобальную переменную  
В) Передавать пользователя через query-параметры  
Г) Использовать куки со всеми данными

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 6
Нужно собирать метрики по времени обработки запроса. Какие значения стоит логировать? Отметь все подходящие варианты.

А) Время начала запроса  
Б) Время окончания  
В) Разницу во времени (latency)  
Г) Ключ шифрования JWT

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как трассировка запросов помогает в отладке и мониторинге приложения.

### Вопрос 7
Redis используется как кеш конфигурации. Какие настройки важны на клиенте? Отметь все подходящие варианты.

А) Таймаут подключения  
Б) Таймаут выполнения команд  
В) Максимальное число повторных попыток  
Г) Цвет логотипа Redis

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Основы работы с Redis: установка, настройка, базовые команды (SET, GET, DEL).

### Вопрос 8
Ты хочешь кешировать ответ `/weather`, который обновляется каждые 5 минут. Какой TTL выберешь?

А) 30 секунд  
Б) 5 минут  
В) 1 час  
Г) Без TTL

**Правильный ответ:** Б

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 9
Кеш должен учитывать локаль (`lang`) и валюту (`currency`). Как сформировать ключ, чтобы поддержка понимала логику?

**Правильный ответ:** Например, `f"rates:{lang}:{currency}"` (принимаются эквиваленты)

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения и как структурировать ключи.

### Вопрос 10
Какие причины могут привести к устаревшему кешу? Отметь все подходящие варианты.

А) Источник данных обновился без инвалидации  
Б) Истёк TTL  
В) Разные инстансы системы используют разные ключи  
Г) Пользователь обновил страницу

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 11
Тебе нужно обновить только часть кеша при изменении сегмента пользователей. Какие подходы подходят? Отметь все подходящие варианты.

А) Использовать набор ключей и очищать сегмент по списку  
Б) Использовать префикс `segment:<id>:*` и удалять по SCAN  
В) Сбрасывать весь кеш `FLUSHALL`  
Г) Не обновлять кеш, ждать TTL

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 12
Сервис возвращает отчёты, обновляемые раз в час. Как минимизировать задержки и поддерживать свежесть? Отметь все подходящие варианты.

А) Кешировать отчёт, но запускать фоновые задачи, которые обновляют кеш заранее  
Б) Устанавливать TTL = 3600 секунд  
В) Отказываться от кеша  
Г) Инвалидировать кеш по событию обновления данных

**Правильные ответы:** А, Г

**Проверяемый ОР:** Понимает. - Какие стратегии кеширования лучше подходят для разных сценариев.

### Вопрос 13
Как узнать остаток времени жизни ключа `inventory:summary`?

А) `TTL inventory:summary`  
Б) `PTTL inventory:summary`  
В) `EXPIRE inventory:summary 60`  
Г) `SCAN inventory:*`

**Правильные ответы:** А, Б

**Проверяемый ОР:** Знает. - Что такое TTL (Time to Live) и как его использовать в кешировании.

### Вопрос 14
Ты строишь слой кеширования поверх сервисов. Что нужно предусмотреть на этапе дизайна? Отметь все подходящие варианты.

А) Логику формирования ключа  
Б) Сериализацию и десериализацию данных  
В) Механизм cache busting при обновлении  
Г) Добавление CSS для UI

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как интегрировать Redis с FastAPI для кеширования API-ответов.

### Вопрос 15
Логирование производительности API зашумлено. Какие данные стоит оставить? Отметь все подходящие варианты.

А) `request_id`  
Б) `endpoint`  
В) `duration_ms`  
Г) Ключи всех переменных окружения

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 16
На каком уровне логировать неожиданные исключения обработчика?

А) DEBUG  
Б) INFO  
В) ERROR  
Г) WARNING

**Правильный ответ:** В

**Проверяемый ОР:** Знает. - Уровни логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL.

### Вопрос 17
Чтобы логи были пригодны для поиска, какие поля нужно включить в формат? Отметь все подходящие варианты.

А) `timestamp`  
Б) `level`  
В) `service_name`  
Г) `random_seed`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Как настраивать форматы логов для удобства чтения.

### Вопрос 18
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

А) Настроить общий форматтер и подключить его ко всем логгерам  
Б) Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст  
В) Писать логи через `print`  
Г) Создать middleware, которое добавляет формат каждому сообщению

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 19
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

А) Создать `AsyncIOScheduler`  
Б) Добавить задачу с `trigger='interval', minutes=15`  
В) Запустить `scheduler.start()`  
Г) Запустить `scheduler.stop()`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как APScheduler помогает в планировании периодических задач.

### Вопрос 20
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься?

А) Оборачивать задачу в try/except  
Б) Добавить уведомления при исключениях  
В) Ничего не нужно делать, задача перезапустится автоматически  
Г) Логировать ошибки

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Понимает. - Какие ошибки могут возникать при работе с фоновыми задачами и как их устранять.

### Вопрос 21
Ты решаешь, когда использовать `BackgroundTasks`, а когда APScheduler. Какие критерии верны? Отметь все подходящие варианты.

А) `BackgroundTasks` привязан к запросу, APScheduler — к расписанию  
Б) APScheduler подходит для периодических задач  
В) `BackgroundTasks` запускаются после формирования ответа  
Г) APScheduler работает только в dev-режиме

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Различие между BackgroundTasks в FastAPI и APScheduler.

### Вопрос 22
Как гарантировать, что планировщик продолжит работу после рестарта приложения?

А) Хранить задания в persistent store вроде Redis  
Б) Запускать APScheduler отдельно от основного приложения  
В) Использовать in-memory store  
Г) Надеяться на авто-восстановление

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 23
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения?

А) Создать зависимость `get_db` и использовать Depends, возвращая сессию  
Б) Создать зависимость `get_cache` для Redis  
В) Создавать соединение внутри эндпоинта через глобальную переменную  
Г) Передавать подключения через аргументы эндпоинта

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как DI помогает в интеграции с внешними сервисами и базами данных.

### Вопрос 24
Почему DI полезен при поддержке сервисов с множеством интеграций? Отметь все подходящие варианты.

А) Позволяет подменять реализации (staging vs prod)  
Б) Централизует управление жизненным циклом ресурсов  
В) Упрощает тестирование с помощью заглушек  
Г) Делает код автоматически быстрее

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Преимущества DI для тестирования и поддержки кода.

### Вопрос 25
Нужно объявить асинхронную зависимость, которая подключается к Redis и закрывает соединение после использования. Какой шаблон подойдёт?
```python
async def get_redis():
    async with aioredis.from_url(URL) as conn:
        yield conn
```
(принимаются эквиваленты с `yield`)

**Проверяемый ОР:** Понимает. - Как асинхронные зависимости улучшают производительность приложения.

### Вопрос 26
Ты хочешь ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

А) Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии  
Б) Проверять ключ внутри каждого эндпоинта  
В) Хранить ключ в глобальной переменной без проверки  
Г) Передавать ключ через swagger

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как Depends помогает централизовать проверки доступа.

### Вопрос 27
Как middleware и зависимости взаимодействуют в FastAPI?

А) Middleware оборачивает запрос до вызова зависимостей  
Б) Зависимости выполняются раньше middleware  
В) Middleware работает только для POST-запросов  
Г) Порядок произвольный

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 28
Как масштабировать конфиги приложения через DI?

А) Создать `Settings` на базе `pydantic` и внедрять через зависимость  
Б) Читать `.env` в каждом эндпоинте  
В) Передавать конфигурацию через заголовки  
Г) Хранить настройки в глобальной переменной без синхронизации

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему DI упрощает управление зависимостями в крупных проектах.

### Вопрос 29
В проекте нужно логировать `request_id` без явного указания в каждом логе. Как это сделать?

А) Middleware записывает `request_id` в `contextvars`, логгер использует фильтр/адаптер  
Б) Прописывать `request_id` вручную в каждом сообщении  
В) Использовать `LoggerAdapter`, добавляющий поле из контекста  
Г) Отказаться от контекста ради производительности

**Правильные ответы:** А, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 30
Как построить цепочку «middleware кеша → зависимость сервиса → бизнес-логика»?

А) Middleware проверяет кеш и пишет данные в `request.state`, зависимость читает и при отсутствии данных обращается в сервис  
Б) Сервис обращается в кеш напрямую без middleware  
В) Кеш вызывается после выполнения сервиса  
Г) Вся логика в одном эндпоинте

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 31
Нужно удалить кеш при обновлении товара. Какую команду Redis вызовешь?

**Правильный ответ:** `DEL key` (принимаются `await redis.delete(key)`)

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 32
Как middleware может усилить безопасность при работе с внешними интеграциями? Отметь все подходящие варианты.

А) Проверять наличие обязательных заголовков и сертификатов  
Б) Ограничивать доступ по списку разрешённых IP  
В) Сбрасывать запросы, если истёк тайм-аут  
Г) Игнорировать ответные заголовки

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как middleware может улучшить безопасность приложения.

### Вопрос 33
Бэкенд обрабатывает тяжёлые отчёты в фоновом планировщике на том же сервере, что и REST API. После запуска фоновых задач latency API вырос. Что поможет снизить влияние на производительность? Отметь все подходящие варианты.

А) Вынести фоновый воркер в отдельный процесс или сервис  
Б) Ограничить количество одновременных задач через пул исполнителей  
В) Кешировать промежуточные результаты и отдавать их, а не пересчитывать каждый раз  
Г) Поднять уровень логирования до DEBUG для задач

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 34
Назови три обязательных поля в структурированном логе для расследования инцидентa. Напиши через запятую.

**Правильный ответ:** `timestamp, level, request_id` (принимаются варианты с `user_id`, `service`)

**Проверяемый ОР:** Знает. - Что такое логирование и зачем оно нужно.

