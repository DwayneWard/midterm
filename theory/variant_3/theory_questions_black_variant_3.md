# Теоретическая часть контрольной работы. Вариант 3
## Разработка на Python. Профессиональный

### Вопрос 1
В апи-gateway нужно добавить middleware, который проставляет `trace_id` для всех запросов. Как обеспечить, чтобы downstream-сервисы тоже получали идентификатор?

А) Передавать `trace_id` через `request.state` без заголовков
Б) Записывать `trace_id` в `request.state`, а затем добавлять его в заголовок ответа
В) Добавлять `trace_id` только в заголовки ответа, без сохранения в `request.state`
Г) Проставлять заголовок `X-Trace-Id` до вызова `call_next`

**Правильный ответ:** Г

**Проверяемый ОР:** Знает. - Что такое middleware и его роль в обработке запросов и ответов.



### Вопрос 2
Нужно собирать метрики по времени обработки запроса. Какие значения нужно логировать? Отметь все подходящие варианты.

А) Время начала запроса
Б) `request.url.path`
В) Время окончания
Г) Разницу во времени (latency)

**Правильные ответы:** А, В, Г

**Проверяемый ОР:** Понимает. - Как трассировка запросов помогает в отладке и мониторинге приложения.



### Вопрос 3
Создаётся слой кеширования поверх сервисов. Что нужно предусмотреть на этапе дизайна? Отметь все подходящие варианты.

А) Сериализацию и десериализацию данных
Б) Логику формирования ключа
В) Механизм cache busting при обновлении
Г) Обработку ошибок подключения к Redis

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как интегрировать Redis с FastAPI для кеширования API-ответов.



### Вопрос 4
Как узнать остаток времени жизни ключа `inventory:summary`?

А) `GET inventory:summary`
Б) `TTL inventory:summary`
В) `EXPIRE inventory:summary 60`
Г) `PTTL inventory:summary`

**Правильные ответы:** Б, Г

**Проверяемый ОР:** Знает. - Что такое TTL (Time to Live) и как его использовать в кешировании.



### Вопрос 5
Внедряется middleware для добавления `request_id`. Какие шаги обязательны? Отметь все подходящие варианты.

А) Использовать только входящий `X-Request-Id`, не генерировать новый
Б) Записать `request_id` в `request.state` и заголовки ответа
В) Проверить, есть ли `X-Request-Id` в входящих заголовках
Г) Сгенерировать новый `uuid4`, если идентификатора нет

**Правильные ответы:** Б, В, Г

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.



### Вопрос 6
Нужно объявить асинхронную зависимость, которая подключается к Redis и закрывает соединение после использования. Какой шаблон подойдёт?
```python
async def get_redis():
    async with aioredis.from_url(URL) as conn:
        yield conn
```
(принимаются эквиваленты с `yield`)

**Проверяемый ОР:** Понимает. - Как асинхронные зависимости улучшают производительность приложения.



### Вопрос 7
Middleware навешивает `user` в `request.state`. Как организовать доступ к нему из зависимостей?

А) Использовать `Depends` с функцией, которая читает из `request.state`
Б) Использовать `request.app.state.user` для хранения пользователя
В) Передавать пользователя через заголовки запроса
Г) В зависимости получить `request: Request` и читать `request.state.user`

**Правильный ответ:** Г

**Проверяемый ОР:** Знает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.



### Вопрос 8
Почему DI полезен при поддержке сервисов с множеством интеграций? Отметь все подходящие варианты.

А) Централизует управление жизненным циклом ресурсов
Б) Упрощает рефакторинг зависимостей без изменения всех эндпоинтов
В) Упрощает тестирование с помощью заглушек
Г) Позволяет подменять реализации (staging vs prod)

**Правильные ответы:** А, В, Г

**Проверяемый ОР:** Понимает. - Преимущества DI для тестирования и поддержки кода.



### Вопрос 9
Нужно удалить кеш при обновлении товара. Какую команду Redis использовать?

**Правильный ответ:** `DEL key` (принимаются `await redis.delete(key)`)

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.



### Вопрос 10
На каком уровне логировать неожиданные исключения обработчика?

А) WARNING
Б) DEBUG
В) ERROR
Г) INFO

**Правильный ответ:** В

**Проверяемый ОР:** Знает. - Уровни логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL.



### Вопрос 11
Как масштабировать конфиги приложения через DI?

А) Читать `.env` в каждом эндпоинте
Б) Передавать конфигурацию через заголовки
В) Создать `Settings` на базе `pydantic` и внедрять через зависимость
Г) Хранить настройки в глобальной переменной модуля

**Правильный ответ:** В

**Проверяемый ОР:** Понимает. - Почему DI упрощает управление зависимостями в крупных проектах.



### Вопрос 12
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения?

А) Создать зависимость `get_cache` для Redis
Б) Создавать соединение внутри эндпоинта через глобальную переменную
В) Передавать подключения через аргументы эндпоинта
Г) Создать зависимость `get_db` и использовать Depends, возвращая сессию

**Правильные ответы:** А, Г

**Проверяемый ОР:** Понимает. - Как DI помогает в интеграции с внешними сервисами и базами данных.



### Вопрос 13
Логирование производительности API зашумлено. Какие данные нужно оставить? Отметь все подходящие варианты.

А) `duration_ms`
Б) `method`
В) `endpoint`
Г) `request_id`

**Правильные ответы:** А, В, Г

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.



### Вопрос 14
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься?

А) Логировать ошибки
Б) Добавить уведомления при исключениях
В) Использовать `scheduler.shutdown()` при завершении приложения
Г) Оборачивать задачу в try/except

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Понимает. - Какие ошибки могут возникать при работе с фоновыми задачами и как их устранять.



### Вопрос 15
В проекте используются три middleware: `AuthMiddleware`, `TimingMiddleware` и `LoggingMiddleware`. Они подключены в таком порядке:
```python
app.add_middleware(AuthMiddleware)
app.add_middleware(TimingMiddleware)
app.add_middleware(LoggingMiddleware)
```
В каком порядке они выполняются при обработке запроса?

А) LoggingMiddleware → TimingMiddleware → AuthMiddleware → обработчик → AuthMiddleware → TimingMiddleware → LoggingMiddleware
Б) Порядок определяется порядком регистрации, но только для request-части
В) Все middleware выполняются параллельно до обработчика
Г) AuthMiddleware → TimingMiddleware → LoggingMiddleware → обработчик → LoggingMiddleware → TimingMiddleware → AuthMiddleware

**Правильный ответ:** Г

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.



### Вопрос 16
Redis используется как кеш конфигурации. Какие настройки важны на клиенте? Отметь все подходящие варианты.

А) Таймаут выполнения команд
Б) Максимальное число повторных попыток
В) Таймаут подключения
Г) Пароль для аутентификации

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Основы работы с Redis: установка, настройка, базовые команды (SET, GET, DEL).



### Вопрос 17
Сервис возвращает отчёты, обновляемые раз в час. Как минимизировать задержки и поддерживать свежесть? Отметь все подходящие варианты.

А) Устанавливать TTL = 3600 секунд
Б) Инвалидировать кеш по событию обновления данных
В) Кешировать отчёт, но запускать фоновые задачи, которые обновляют кеш заранее
Г) Использовать только TTL без событийной инвалидации

**Правильные ответы:** Б, В

**Проверяемый ОР:** Понимает. - Какие стратегии кеширования лучше подходят для разных сценариев.



### Вопрос 18
Middleware логирует ответы, включая тела JSON. Какие риски нужно учитывать? Отметь все подходящие варианты.

А) В логах могут оказаться чувствительные данные
Б) Повторное чтение тела может потребовать восстановить `response.body`
В) Тело ответа можно читать только один раз без восстановления потока
Г) Логирование больших тел увеличивает задержку

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Понимает. - Как middleware влияет на производительность приложения.



### Вопрос 19
Кеш должен учитывать локаль (`lang`) и валюту (`currency`). Как сформировать ключ, чтобы поддержка понимала логику?

**Правильный ответ:** Например, `f"rates:{lang}:{currency}"` (принимаются эквиваленты)

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения и как структурировать ключи.



### Вопрос 20
Нужно обновить только часть кеша при изменении сегмента пользователей. Какие подходы подходят? Отметь все подходящие варианты.

А) Использовать `KEYS segment:<id>:*` и удалять найденные ключи
Б) Не обновлять кеш, ждать истечения TTL
В) Использовать префикс `segment:<id>:*` и удалять по SCAN
Г) Использовать набор ключей и очищать сегмент по списку

**Правильные ответы:** В, Г

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.



### Вопрос 21
Какие причины могут привести к устаревшему кешу? Отметь все подходящие варианты.

А) Разные инстансы системы используют разные ключи
Б) Истёк TTL
В) Источник данных обновился без инвалидации
Г) Кеш был установлен с очень длинным TTL без обновления

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.



### Вопрос 22
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

А) Создать middleware, которое добавляет формат каждому сообщению
Б) Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст
В) Настроить общий форматтер и подключить его ко всем логгерам
Г) Использовать общий форматтер для всех логгеров через `basicConfig`

**Правильные ответы:** Б, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.



### Вопрос 23
Нужно определить, когда использовать `BackgroundTasks`, а когда APScheduler. Какие критерии верны? Отметь все подходящие варианты.

А) APScheduler подходит для периодических задач
Б) `BackgroundTasks` запускаются после формирования ответа
В) `BackgroundTasks` привязан к запросу, APScheduler — к расписанию
Г) APScheduler требует явного вызова `scheduler.start()`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Различие между BackgroundTasks в FastAPI и APScheduler.



### Вопрос 24
Нужно кешировать ответ `/weather`, который обновляется каждые 5 минут. Какой TTL выбрать?

А) 30 секунд
Б) Без TTL
В) 1 час
Г) 5 минут

**Правильный ответ:** Г

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.



### Вопрос 25
Чтобы логи были пригодны для поиска, какие поля нужно включить в формат? Отметь все подходящие варианты.

А) `service_name`
Б) `level`
В) `message`
Г) `timestamp`

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Знает. - Как настраивать форматы логов для удобства чтения.



### Вопрос 26
Как гарантировать, что планировщик продолжит работу после рестарта приложения?

А) Хранить задания в persistent store вроде Redis
Б) Использовать `scheduler.shutdown()` при завершении приложения
В) Запускать APScheduler отдельно от основного приложения
Г) Настроить `lifespan` для управления жизненным циклом

**Правильные ответы:** А, В

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.



### Вопрос 27
Нужно ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

А) Использовать middleware без проверки ключа
Б) Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии
В) Хранить ключ в глобальной переменной без проверки
Г) Проверять ключ внутри каждого эндпоинта

**Правильный ответ:** Б

**Проверяемый ОР:** Понимает. - Как Depends помогает централизовать проверки доступа.



### Вопрос 28
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

А) Добавить задачу с `IntervalTrigger(minutes=15)`
Б) Настроить `lifespan` для управления жизненным циклом
В) Создать `AsyncIOScheduler`
Г) Запустить `scheduler.start()`

**Правильные ответы:** А, В, Г

**Проверяемый ОР:** Понимает. - Как APScheduler помогает в планировании периодических задач.

