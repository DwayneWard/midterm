# Теоретическая часть контрольной работы. Вариант 6
## Разработка на Python. Профессиональный

### Вопрос 1
В сервисе ты добавляешь middleware для проставления `trace_id`. Где лучше генерировать идентификатор, чтобы он попал во все downstream-вызовы?

А) До `await call_next(request)`, сохранив значение в `request.state` и заголовках  
Б) После получения ответа  
В) В каждом эндпоинте вручную  
Г) В Celery-задаче

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Что такое middleware и его роль в обработке запросов и ответов.

### Вопрос 2
Ты хочешь централизованно проставлять `X-Env` в ответах. Какие шаги нужны в middleware? Отметь все подходящие варианты.

А) Получить значение окружения из настроек  
Б) Вызвать `response = await call_next(request)`  
В) Добавить заголовок в `response.headers`  
Г) Вернуть `None` и довериться FastAPI

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 3
Middleware блокирует запросы от ботов по `User-Agent`. Как хранить список запрещённых агентов?

А) Загружать при старте приложения из конфигурации и кешировать  
Б) Читать файл на каждом запросе  
В) Сохранять в глобальной переменной без синхронизации  
Г) Полагаться на фронтенд

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему middleware полезен для централизованной обработки запросов.

### Вопрос 4
Ты логируешь тело ответа в middleware. Какие риски стоит учитывать? Отметь все подходящие варианты.

А) Потребуется восстановить поток, иначе клиент получит пустой ответ  
Б) Увеличатся задержки из-за сериализации  
В) В логи могут попасть ПДн  
Г) FastAPI автоматически дублирует тело

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware влияет на производительность приложения.

### Вопрос 5
Middleware добавляет `user_id` в `request.state`. Как безопасно использовать его в зависимости?

А) Проверить наличие атрибута и вернуть 401 при отсутствии  
Б) Держать список пользователей в глобальной переменной  
В) Передавать `user_id` через query-параметр  
Г) Не проверять, что значение существует

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 6
Ты измеряешь время ответа в middleware. Что записывать в лог? Отметь все подходящие варианты.

А) Timestamp начала  
Б) Timestamp окончания  
В) Продолжительность запроса  
Г) Хеш коммита

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как трассировка запросов помогает в отладке и мониторинге приложения.

### Вопрос 7
Redis используется как кеш для справочников. Какие параметры клиента критичны? Отметь все подходящие варианты.

А) Таймаут подключения  
Б) Таймаут команд  
В) Количество попыток переподключения  
Г) Путь до favicon

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Основы работы с Redis: установка, настройка, базовые команды (SET, GET, DEL).

### Вопрос 8
Эндпоинт `/prices` обновляется каждые 2 минуты. Какой TTL поставить для кеша ответа?

А) 120 секунд  
Б) 5 секунд  
В) 30 минут  
Г) Без TTL

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 9
Ключ кеша должен учитывать `product_id` и `currency`. Как построить ключ, чтобы поддержка понимала структуру?

**Правильный ответ:** Например, `f"price:{product_id}:{currency}"` (принимаются эквиваленты)

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения и как структурировать ключи.

### Вопрос 10
Кеш возвращает устаревшие данные по заказам. Какие причины стоит проверить? Отметь все подходящие варианты.

А) Нет инвалидации после обновления заказов  
Б) Разные сервисы используют разные префиксы ключей  
В) TTL слишком длинный  
Г) Пользователь обновил браузер

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 11
Как сбросить кеш сегмента клиентов при обновлении данных?

А) Хранить ключи сегмента в `SET` и удалять их  
Б) Удалять по `segment:<id>:*` через `SCAN`  
В) `FLUSHDB`  
Г) Ждать TTL

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 12
Отчёты формируются долго, но обновляются каждые 4 часа. Как держать данные актуальными и снизить нагрузку? Отметь все подходящие варианты.

А) Настроить фоновые задачи, обновляющие кеш заранее  
Б) Кешировать результаты и инвалидировать по событию  
В) Отказаться от кеша  
Г) Обновлять отчёт при каждом запросе

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Какие стратегии кеширования лучше подходят для разных сценариев.

### Вопрос 13
Как быстро посмотреть, сколько осталось жить ключу `promo:active`?

А) `TTL promo:active`  
Б) `PTTL promo:active`  
В) `EXPIRE promo:active 0`  
Г) `LINDEX promo:active 0`

**Правильные ответы:** А, Б

**Проверяемый ОР:** Знает. - Что такое TTL (Time to Live) и как его использовать в кешировании.

### Вопрос 14
Ты создаёшь кеширующий слой. Какие компоненты обязательны? Отметь все подходящие варианты.

А) Функция формирования ключей  
Б) Сериализация/десериализация данных  
В) Инвалидация при событии обновления  
Г) Схемы миграций БД

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как интегрировать Redis с FastAPI для кеширования API-ответов.

### Вопрос 15
Логирование заполняет диски, и тебе нужно оставить только полезные поля. Что стоит логировать? Отметь все подходящие варианты.

А) `request_id`  
Б) `method`  
В) `status_code`  
Г) `python_version`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 16
Какой уровень логирования выбрать для неожиданной ошибки бизнес-логики?

А) ERROR  
Б) WARNING  
В) INFO  
Г) DEBUG

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Уровни логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL.

### Вопрос 17
Чтобы логи были пригодны для анализа инцидентов, какие поля добавишь? Отметь все подходящие варианты.

А) `timestamp`  
Б) `level`  
В) `service`  
Г) `random_seed`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Как настраивать форматы логов для удобства чтения.

### Вопрос 18
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

А) Настроить общий форматтер и подключить его ко всем логгерам  
Б) Использовать `LoggerAdapter`, чтобы автоматически добавлять контекст  
В) Писать логи через `print`  
Г) Создать middleware, которое добавляет формат каждому сообщению

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 19
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

А) Создать `AsyncIOScheduler`  
Б) Добавить задачу с `trigger='interval', minutes=15`  
В) Запустить `scheduler.start()`  
Г) Запустить `scheduler.stop()`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как APScheduler помогает в планировании периодических задач.

### Вопрос 20
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься?

А) Оборачивать задачу в try/except  
Б) Добавить уведомления при исключениях  
В) Ничего не нужно делать, задача перезапустится автоматически  
Г) Логировать ошибки

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Понимает. - Какие ошибки могут возникать при работе с фоновыми задачами и как их устранять.

### Вопрос 21
Чем `BackgroundTasks` отличается от APScheduler? Отметь все подходящие варианты.

А) `BackgroundTasks` запускает действия сразу после ответа  
Б) APScheduler работает по расписанию  
В) `BackgroundTasks` привязан к конкретному запросу  
Г) APScheduler не поддерживает асинхронность

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Различие между BackgroundTasks в FastAPI и APScheduler.

### Вопрос 22
Как обеспечить сохранность расписания при рестарте приложения?

А) Использовать persistent job store (Redis, БД)  
Б) Запускать APScheduler в отдельном процессе  
В) Использовать только in-memory  
Г) Надеяться, что задачи восстановятся сами

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 23
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения?

А) Создать зависимость `get_db` и использовать Depends, возвращая сессию  
Б) Создать зависимость `get_cache` для Redis  
В) Создавать соединение внутри эндпоинта через глобальную переменную  
Г) Передавать подключения через аргументы эндпоинта

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как DI помогает в интеграции с внешними сервисами и базами данных.

### Вопрос 24
Почему DI облегчает поддержку и развитие сервисов? Отметь все подходящие варианты.

А) Позволяет подменять реализации (mock vs prod)  
Б) Централизует контроль жизненного цикла ресурсов  
В) Упрощает тестирование за счёт заглушек  
Г) Автоматически оптимизирует SQL-запросы

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Преимущества DI для тестирования и поддержки кода.

### Вопрос 25
Нужно объявить асинхронную зависимость, которая подключается к Redis и закрывает соединение после использования. Какой шаблон подойдёт?
```python
async def get_redis():
    async with aioredis.from_url(URL) as conn:
        yield conn
```
(принимаются эквиваленты с `yield`)
**Проверяемый ОР:** Понимает. - Как асинхронные зависимости улучшают производительность приложения.

### Вопрос 26
Ты хочешь ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

А) Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии  
Б) Проверять ключ внутри каждого эндпоинта  
В) Хранить ключ в глобальной переменной без проверки  
Г) Передавать ключ через swagger

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как Depends помогает централизовать проверки доступа.

### Вопрос 27
Как middleware и зависимости взаимодействуют?

А) Middleware выполняется первыми и подготавливает контекст для зависимостей  
Б) Зависимости выполняются до middleware  
В) Порядок случайный  
Г) Middleware применяется только к POST

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 28
Как внедрять настройки приложения через DI?

А) Создать `Settings` на базе `pydantic` и инжектировать через зависимость  
Б) Читать `.env` в каждом эндпоинте  
В) Передавать настройки через заголовки  
Г) Глобально хранить словарь без заморочек

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему DI упрощает управление зависимостями в крупных проектах.

### Вопрос 29
Нужно логировать `request_id` в каждом сообщении без явного указания. Как комбинировать middleware и logging?

А) Middleware сохраняет `request_id` в `contextvars`, логгер использует фильтр/адаптер  
Б) Добавлять `request_id` вручную в каждой строке  
В) Настроить `LoggerAdapter`, который подмешивает поле  
Г) Отключить контекст ради производительности

**Правильные ответы:** А, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 30
Кеш должен обрабатываться до бизнес-логики. Какой пайплайн выстроишь?

А) Middleware проверяет кеш и пишет данные в `request.state`, зависимость сервиса использует их или вызывает БД  
Б) Бизнес-логика сначала идёт в БД  
В) Кеш вызывается после выполнения сервиса  
Г) Всё в эндпоинте

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 31
Как удалить кеш при обновлении товара? Какую команду Redis вызовёшь?

**Правильный ответ:** `DEL key` (принимаются `await redis.delete(key)`)

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 32
Как middleware может усилить безопасность API интеграций? Отметь все подходящие варианты.

А) Проверять цифровые подписи или HMAC  
Б) Ограничивать частоту запросов по IP  
В) Валидировать обязательные заголовки  
Г) Игнорировать отсутствие токена

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware может улучшить безопасность приложения.

### Вопрос 33
Бэкенд обрабатывает тяжёлые отчёты в фоновом планировщике на том же сервере, что и REST API. После запуска фоновых задач latency API вырос. Что поможет снизить влияние на производительность? Отметь все подходящие варианты.

А) Вынести фоновый воркер в отдельный процесс или сервис  
Б) Ограничить количество одновременных задач через пул исполнителей  
В) Кешировать промежуточные результаты и отдавать их, а не пересчитывать каждый раз  
Г) Поднять уровень логирования до DEBUG для задач

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 34
Назови три обязательных поля в структурированном логе для расследования инцидента. Напиши через запятую.

**Правильный ответ:** `timestamp, request_id, user_id` (принимаются эквиваленты)

**Проверяемый ОР:** Знает. - Что такое логирование и зачем оно нужно.

