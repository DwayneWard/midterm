# Теоретическая часть контрольной работы. Вариант 2
## Разработка на Python. Профессиональный

### Вопрос 1
В сервисе появился middleware, который должен проставлять `request_id` для каждого входящего запроса. Где лучше всего генерировать идентификатор?

А) В начале middleware до вызова `call_next`  
Б) В конце middleware после получения ответа  
В) В каждом эндпоинте руками  
Г) В фоне отдельным scheduled-job

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Что такое middleware и его роль в обработке запросов и ответов.

### Вопрос 2
Ты хочешь, чтобы все ответы API содержали заголовок `X-Trace-Id`. Какие действия нужны в middleware? Отметь все подходящие варианты.

А) Создать или взять `trace_id` из запроса  
Б) Вызвать `response = await call_next(request)`  
В) Добавить заголовок `response.headers["X-Trace-Id"] = trace_id`  
Г) Вернуть `None`, FastAPI сам добавит заголовок

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 3
Middleware проверяет токен доступа для private API. Что произойдёт, если ты вызовешь `call_next` и только потом проверишь токен?

А) Эндпоинт выполнится, даже если токен недействителен  
Б) FastAPI автоматически прервёт обработку  
В) Пользователь увидит 401 до выполнения эндпоинта  
Г) Запрос уйдёт в вечный цикл

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему middleware полезен для централизованной обработки запросов.

### Вопрос 4
В логах ты хочешь видеть тело запроса. Какие меры нужны, чтобы не повредить работу приложения? Отметь все подходящие варианты.

А) Считывать тело через `await request.body()` и записывать обратно в `request._body`  
Б) Ограничить размер логируемого тела  
В) Фильтровать чувствительные поля перед логированием  
Г) Использовать `print(body)`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как middleware влияет на производительность приложения.

### Вопрос 5
Middleware должен сделать доступным текущего пользователя всем зависимостям. Как это реализовать?

А) Сохранить объект пользователя в `request.state.user`  
Б) Сохранить пользователя в глобальной переменной модуля  
В) Передать пользователя через query-параметр  
Г) Дублировать информацию в ответе

**Правильный ответ:** А

**Проверяемый ОР:** Знает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 6
Тебе нужно добавить централизованное логирование длительности запроса. Какие шаги обязательны? Отметь все подходящие варианты.

А) Зафиксировать время начала до `call_next`  
Б) Получить время окончания после `call_next`  
В) Логировать дельту и идентификатор запроса  
Г) Хранить время начала в глобальной переменной без очистки

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как трассировка запросов помогает в отладке и мониторинге приложения.

### Вопрос 7
Команда запускает Redis для кеша. Какой командой из CLI проверишь, что сервис отвечает?

**Правильный ответ:** `redis-cli PING`

**Проверяемый ОР:** Знает. - Основы работы с Redis: установка, настройка, базовые команды (SET, GET, DEL).

### Вопрос 8
API отдаёт курс валют, который обновляется каждую минуту. Какой TTL выбрать для кеша ответа?

А) 30 секунд  
Б) 60 секунд  
В) 10 минут  
Г) Без TTL

**Правильный ответ:** Б

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 9
Платформа рассылок кеширует статистику кампаний. Ключ должен учитывать `campaign_id`, `segment` и версию эксперимента. Какие данные стоит использовать в качестве ключа? Отметь все подходящие варианты.
А) Путь запроса (`/campaigns`)  
Б) Важные query-параметры (`segment`, `variant`)  
В) JWT пользователя  
Г) Версию API
**Правильные ответы:** А, Б, Г
**Проверяемый ОР:** Понимает. - Какие данные лучше кешировать, а какие — нет.

### Вопрос 10
Команда аналитики хранит агрегаты в Redis для панели «эффективность кампаний». Какой формат выбрать, чтобы фронтенд безболезненно парсил данные?
**Правильный ответ:** JSON-строка (принимаются варианты с `json.dumps`)
**Проверяемый ОР:** Понимает. - Почему Redis популярен как хранилище кеша и как выбирать формат данных.

### Вопрос 11
После запуска промо-кампании нужно быстро сбросить кеш конкретного сегмента. Какие подходы подходят? Отметь все подходящие варианты.
А) Хранить ключи сегмента в `SET` и удалять их  
Б) Использовать префикс `segment:<id>` и удалять через `SCAN`  
В) Удалять весь Redis `FLUSHALL`  
Г) Игнорировать, пока TTL не истечёт
**Правильные ответы:** А, Б
**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 12
Маркетинг хочет держать дэшборд «онлайн-конверсии» максимально свежим. Какие приёмы помогут балансировать стоимость пересчёта и актуальность? Отметь все подходящие варианты.
А) Выдавать кеш и параллельно запускать пересчёт (stale-while-revalidate)  
Б) Хранить отчёты без TTL  
В) Инвалидировать кеш по вебхуку из основной БД  
Г) Запрещать кеширование каждый второй запрос
**Правильные ответы:** А, В
**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 13
Дежурный должен выяснить, успеет ли истечь ключ `segment:42`. Какие команды Redis помогут? Отметь все подходящие варианты.
А) `TTL segment:42`  
Б) `PTTL segment:42`  
В) `EXPIRE segment:42 0`  
Г) `SCAN segment:*`
**Правильные ответы:** А, Б
**Проверяемый ОР:** Знает. - Что такое TTL (Time to Live) и как его использовать в кешировании.

### Вопрос 14
Перед отправкой кампаний QA проверяет архитектуру кеша. Какие элементы должен включать общий helper? Отметь все подходящие варианты.
А) Зависимость, которая проверяет Redis перед выполнением бизнес-логики  
Б) Функцию сериализации/десериализации ответа  
В) Сигнал на удаление кеша после записи в БД  
Г) Миграцию схемы базы
**Правильные ответы:** А, Б, В
**Проверяемый ОР:** Понимает. - Как интегрировать Redis с FastAPI для кеширования API-ответов.

### Вопрос 15
JSON-ответ весит 5 МБ, и логирование всех примеров перегружает диск. Что предпримешь? Отметь все подходящие варианты.

А) Ограничить размер записей через фильтр логирования  
Б) Перевести формат логов на JSON и писать в stdout  
В) Добавить троттлинг логов по количеству  
Г) Писать логи в файл и удалять их вручную

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 16
Какой уровень логирования использовать для сообщения об ошибке валидации входных данных?

А) DEBUG  
Б) INFO  
В) WARNING  
Г) ERROR

**Правильный ответ:** В

**Проверяемый ОР:** Знает. - Уровни логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL.

### Вопрос 17
Логи нужно связать с конкретной операцией пользователя. Какие поля включишь в формат? Отметь все подходящие варианты.

А) `timestamp`  
Б) `request_id`  
В) `user_id`  
Г) `python_version`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Знает. - Как настраивать форматы логов для удобства чтения.

### Вопрос 18
В проекте используются разные логгеры. Как обеспечить единый формат? Отметь все подходящие варианты.

А) Настроить `logging.dictConfig` с общим форматтером  
Б) Использовать `structlog` или собственный адаптер  
В) Настроить `LoggerAdapter`, который добавляет контекст  
Г) Позволить каждому модулю использовать свой формат

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 19
Нужно запустить отчёт об оплатах каждые 15 минут. Какие шаги нужны при использовании APScheduler? Отметь все подходящие варианты.

А) Создать `AsyncIOScheduler`  
Б) Добавить задачу с `trigger='interval', minutes=15`  
В) Запустить `scheduler.start()`  
Г) Запустить `scheduler.stop()`

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как APScheduler помогает в планировании периодических задач.

### Вопрос 20
В продакшне задача APScheduler внезапно прекращает работать после исключения. Как защититься?

А) Оборачивать задачу в try/except  
Б) Добавить уведомления при исключениях  
В) Ничего не нужно делать, задача перезапустится автоматически  
Г) Логировать ошибки

**Правильные ответы:** А, Б, Г

**Проверяемый ОР:** Понимает. - Какие ошибки могут возникать при работе с фоновыми задачами и как их устранять.

### Вопрос 21
Чем `BackgroundTasks` удобен по сравнению с APScheduler для отправки email после запроса?

**Правильный ответ:** Он привязан к конкретному запросу и запускает задачу сразу после формирования ответа (принимаются эквиваленты)

**Проверяемый ОР:** Знает. - Различие между BackgroundTasks в FastAPI и APScheduler.

### Вопрос 22
Ты хочешь гарантировать, что фоновые задачи не остановятся при перезапуске приложения. Что стоит сделать? Отметь все подходящие варианты.

А) Запускать APScheduler в отдельном процессе или сервисе  
Б) Использовать persistent job store (например, Redis)  
В) Полагаться на in-memory планировщик  
Г) Логировать старт задач

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 23
Эндпоинт требует подключения к БД и кешу. Как организовать зависимости, чтобы переиспользовать соединения?

А) Создать зависимость `get_db` и использовать Depends, возвращая сессию  
Б) Создать зависимость `get_cache` для Redis  
В) Создавать соединение внутри эндпоинта через глобальную переменную  
Г) Передавать подключения через аргументы эндпоинта

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как DI помогает в интеграции с внешними сервисами и базами данных.

### Вопрос 24
Зачем использовать DI при поддержке больших приложений? Отметь все подходящие варианты.

А) Зависимости можно централизованно обновлять и рефакторить без правок во всех эндпоинтах  
Б) Можно подключать разные реализации сервисов в зависимости от окружения  
В) Проще контролировать жизненный цикл ресурсов (открытие/закрытие соединений)  
Г) Не нужно обновлять документацию Swagger

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Преимущества DI для тестирования и поддержки кода.

### Вопрос 25
Нужно объявить асинхронную зависимость, которая подключается к Redis и закрывает соединение после использования. Какой шаблон подойдёт?
```python
async def get_redis():
    async with aioredis.from_url(URL) as conn:
        yield conn
```
(принимаются эквиваленты с `yield`)
**Проверяемый ОР:** Понимает. - Как асинхронные зависимости улучшают производительность приложения.

### Вопрос 26
Ты хочешь ограничить доступ к эндпоинту по API-ключу. Как использовать Depends для проверки заголовка?

А) Создать зависимость `verify_api_key` и бросать `HTTPException` при несоответствии  
Б) Проверять ключ внутри каждого эндпоинта  
В) Хранить ключ в глобальной переменной без проверки  
Г) Передавать ключ через swagger

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как Depends помогает централизовать проверки доступа.

### Вопрос 27
В каком порядке выполняются middleware и зависимости при обработке запроса?

**Правильный ответ:** Сначала middleware, затем зависимости эндпоинта (принимаются эквиваленты)

**Проверяемый ОР:** Понимает. - Как middleware интегрируется в жизненный цикл запроса в FastAPI.

### Вопрос 28
Ты хочешь передавать настройки приложения в зависимости. Какой подход обеспечит гибкость?

А) Использовать `pydantic`-модель настроек и DI `get_settings()`  
Б) Читать `.env` файл внутри каждого эндпоинта  
В) Генерировать настройки на лету из запроса  
Г) Передавать словарь через query-параметры

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Почему DI упрощает управление зависимостями в крупных проектах.

### Вопрос 29
Логи должны автоматически включать `request_id`, если он уже есть в `contextvars`. Как этого добиться?

А) Создать middleware, который пишет `request_id` в контекст, и настроить `LoggerAdapter`  
Б) Добавлять `request_id` в каждое сообщение вручную  
В) Настроить фильтр логгера, который добавляет поле из контекста  
Г) Отключить контекст, чтобы не тратить ресурсы

**Правильные ответы:** А, В

**Проверяемый ОР:** Понимает. - Как структурированное логирование упрощает анализ логов.

### Вопрос 30
Кеш для `/analytics` должен проверяться до выполнения бизнес-логики. Как расположить слои?

А) Middleware для request_id → dependency кеша → сервис  
Б) Сервис → middleware → dependency  
В) Dependency → middleware → сервис  
Г) Запрос сразу в БД без кеша

**Правильный ответ:** А

**Проверяемый ОР:** Понимает. - Как кеширование улучшает производительность приложения.

### Вопрос 31
Обновление каталога товаров требует очистить связанные кеш-ключи. Какие подходы подходят? Отметь все подходящие варианты.

**Правильный ответ:** А, Б (оставляем без изменений)

**Проверяемый ОР:** Понимает. - Как инвалидация кеша помогает поддерживать актуальность данных.

### Вопрос 32
Отсутствие логов по безопасности заметили только через день. Как middleware может улучшить контроль? Отметь все подходящие варианты.

А) Логировать неудачные попытки авторизации с деталями маршрута  
Б) Вести счётчики подозрительных запросов и отправлять алерты  
В) Пропускать все запросы из доверенной подсети без проверки  
Г) Автоматически отключать всех пользователей при первой ошибке

**Правильные ответы:** А, Б

**Проверяемый ОР:** Понимает. - Как middleware может улучшить безопасность приложения.

### Вопрос 33
Когда фоновые задачи выполняются на том же сервере, что и REST API, латентность выросла. Какие шаги помогут снизить влияние? Отметь все подходящие варианты.

А) Вынести фоновый воркер в отдельный процесс или сервис  
Б) Ограничить количество одновременных задач через пул исполнителей  
В) Кешировать промежуточные результаты  
Г) Увеличить уровень логирования до DEBUG

**Правильные ответы:** А, Б, В

**Проверяемый ОР:** Понимает. - Как фоновые задачи влияют на производительность приложения.

### Вопрос 34
Назови три поля, которые стоит обязательно логировать при обработке защищённого запроса. Напиши через запятую.

**Правильный ответ:** `timestamp, request_id, user_id` (принимаются эквиваленты)

**Проверяемый ОР:** Знает. - Что такое логирование и зачем оно нужно.

